name: Build and Deduplicate Clash Rules

on:
  schedule:
    - cron: '0 3 * * *'
  
  push:
    branches:
      - main
    paths:
      - 'reject/**'
      - 'proxy/**'
      - 'direct/**'
      - 'microsoft/**'

  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write

    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      # =======================================================
      #  处理 REJECT 规则
      # =======================================================

      - name: 3. Build REJECT List
        run: |
          echo "Starting REJECT rule download and merge process..."
          touch all_reject_rules.tmp
          while IFS= read -r url || [[ -n "$url" ]]; do
            if [[ "$url" == \#* ]] || [[ -z "$url" ]]; then continue; fi
            echo "  [REJECT] Processing URL: $url"
            curl -s -L -o rule_content.tmp "$url"
            if [ ! -s rule_content.tmp ]; then
              echo "  -> WARNING: Failed to download or file is empty."
              continue
            fi
            if cat rule_content.tmp | yq e '.payload[]' - >> all_reject_rules.tmp 2>/dev/null; then
              echo "  -> Parsed as YAML (raw merge)"
            else
              cat rule_content.tmp >> all_reject_rules.tmp
              echo "  -> Parsed as TXT (raw merge)"
            fi
          done < reject/reject_sources.list
          rm -f rule_content.tmp
          cat reject/reject.txt >> all_reject_rules.tmp
          echo "REJECT list merge complete."

      - name: 4. Filter REJECT List
        run: |
          normalize_rules() {
            sed "s/'//g" \
            | sed -E 's/^\s*#.*//' \
            | sed -E '/^\s*$/d' \
            | sed -E 's/^(DOMAIN|DOMAIN-SUFFIX|IP-CIDR|IP-CIDR6),([^,]+).*/\2/' \
            | grep -v 'payload:' | grep -v '/' | grep -v ':' | grep -v '@' \
            | tr '[:upper:]' '[:lower:]'
          }

          echo "Normalizing REJECT allowlist (reject/exclude.txt)..."
          cat reject/exclude.txt \
            | sed "s/'//g" \
            | sed -E 's/^\s*#.*//' \
            | sed -E '/^\s*$/d' \
            | tr '[:upper:]' '[:lower:]' \
            | sort | uniq \
            > normalized_reject_allowlist.txt

          echo "Normalizing merged REJECT list (all_reject_rules.tmp)..."
          cat all_reject_rules.tmp | normalize_rules > normalized_reject_list.txt || true

          echo "Filtering REJECT list against allowlist..."
          grep -F -v -x -f normalized_reject_allowlist.txt normalized_reject_list.txt > filtered_reject_list.txt || true
          echo "REJECT allowlist filtering complete."

      - name: 5. Format REJECT List
        run: |
          echo "Sorting and deduplicating filtered REJECT list..."
          cat filtered_reject_list.txt | sort | uniq > final_reject_domains.txt || true
          echo "Reformatting for REJECT YAML payload..."
          echo "#########################################" > final_reject.yaml
          echo "# 作者: ningcol" >> final_reject.yaml
          echo "# 项目地址: https://github.com/ningcol/clash-rules" >> final_reject.yaml
          echo "# 更新时间: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> final_reject.yaml
          echo "# 说明: 本文件为自动生成的 Clash REJECT 规则，仅包含域名。" >> final_reject.yaml
          echo "#########################################" >> final_reject.yaml
          echo "payload:" >> final_reject.yaml
          sed "s/^\(.*\)$/  - '\1'/" final_reject_domains.txt >> final_reject.yaml
          echo "REJECT build complete. Final file is final_reject.yaml"
          
      # =======================================================
      #  处理 PROXY 规则
      # =======================================================
      
      - name: 6. Build PROXY List
        run: |
          echo "Starting PROXY rule download and merge process..."
          touch all_proxy_rules.tmp
          while IFS= read -r url || [[ -n "$url" ]]; do 
            if [[ "$url" == \#* ]] || [[ -z "$url" ]]; then continue; fi
            echo "  [PROXY] Processing URL: $url"
            curl -s -L -o rule_content.tmp "$url"
            if [ ! -s rule_content.tmp ]; then
              echo "  -> WARNING: Failed to download or file is empty."
              continue
            fi
            if cat rule_content.tmp | yq e '.payload[]' - >> all_proxy_rules.tmp 2>/dev/null; then
              echo "  -> Parsed as YAML (raw merge)"
            else
              cat rule_content.tmp >> all_proxy_rules.tmp
              echo "  -> Parsed as TXT (raw merge)"
            fi
          done < proxy/proxy_sources.list
          rm -f rule_content.tmp
          cat proxy/proxy.txt >> all_proxy_rules.tmp
          echo "PROXY list merge complete."

      - name: 7. Filter PROXY List
        run: |
          normalize_rules() {
            sed "s/'//g" \
            | sed -E 's/^\s*#.*//' \
            | sed -E '/^\s*$/d' \
            | sed -E 's/^(DOMAIN|DOMAIN-SUFFIX|IP-CIDR|IP-CIDR6),([^,]+).*/\2/' \
            | grep -v 'payload:' | grep -v '/' | grep -v ':' | grep -v '@' \
            | tr '[:upper:]' '[:lower:]'
          }

          echo "Normalizing PROXY allowlist (proxy/exclude.txt)..."
          cat proxy/exclude.txt \
            | sed "s/'//g" \
            | sed -E 's/^\s*#.*//' \
            | sed -E '/^\s*$/d' \
            | tr '[:upper:]' '[:lower:]' \
            | sort | uniq \
            > normalized_proxy_allowlist.txt

          echo "Normalizing merged PROXY list (all_proxy_rules.tmp)..."
          cat all_proxy_rules.tmp | normalize_rules > normalized_proxy_list.txt || true

          echo "Filtering PROXY list against allowlist..."
          grep -F -v -x -f normalized_proxy_allowlist.txt normalized_proxy_list.txt > filtered_proxy_list.txt || true
          echo "PROXY allowlist filtering complete."

      - name: 8. Format PROXY List
        run: |
          echo "Sorting and deduplicating filtered PROXY list..."
          cat filtered_proxy_list.txt | sort | uniq > final_proxy_domains.txt || true
          echo "Reformatting for PROXY YAML payload..."
          echo "#########################################" > final_proxy.yaml
          echo "# 作者: ningcol" >> final_proxy.yaml
          echo "# 项目地址: https://github.com/ningcol/clash-rules" >> final_proxy.yaml
          echo "# 更新时间: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> final_proxy.yaml
          echo "# 说明: 本文件为自动生成的 Clash PROXY 规则，仅包含域名。" >> final_proxy.yaml
          echo "#########################################" >> final_proxy.yaml
          echo "payload:" >> final_proxy.yaml
          sed "s/^\(.*\)$/  - '\1'/" final_proxy_domains.txt >> final_proxy.yaml
          echo "PROXY build complete. Final file is final_proxy.yaml"

      # =======================================================
      #  处理 DIRECT 规则
      # =======================================================

      - name: 9. Build DIRECT List
        run: |
          echo "Starting DIRECT rule download and merge process..."
          touch all_direct_rules.tmp
          while IFS= read -r url || [[ -n "$url" ]]; do 
            if [[ "$url" == \#* ]] || [[ -z "$url" ]]; then continue; fi
            echo "  [DIRECT] Processing URL: $url"
            curl -s -L -o rule_content.tmp "$url"
            if [ ! -s rule_content.tmp ]; then
              echo "  -> WARNING: Failed to download or file is empty."
              continue
            fi
            if cat rule_content.tmp | yq e '.payload[]' - >> all_direct_rules.tmp 2>/dev/null; then
              echo "  -> Parsed as YAML (raw merge)"
            else
              cat rule_content.tmp >> all_direct_rules.tmp
              echo "  -> Parsed as TXT (raw merge)"
            fi
          done < direct/direct_sources.list
          rm -f rule_content.tmp
          cat direct/direct.txt >> all_direct_rules.tmp
          echo "DIRECT list merge complete."

      - name: 10. Filter DIRECT List
        run: |
          normalize_rules() {
            sed "s/'//g" \
            | sed -E 's/^\s*#.*//' \
            | sed -E '/^\s*$/d' \
            | sed -E 's/^(DOMAIN|DOMAIN-SUFFIX|IP-CIDR|IP-CIDR6),([^,]+).*/\2/' \
            | grep -v 'payload:' | grep -v '/' | grep -v ':' | grep -v '@' \
            | tr '[:upper:]' '[:lower:]'
          }

          echo "Normalizing DIRECT allowlist (direct/exclude.txt)..."
          cat direct/exclude.txt \
            | sed "s/'//g" \
            | sed -E 's/^\s*#.*//' \
            | sed -E '/^\s*$/d' \
            | tr '[:upper:]' '[:lower:]' \
            | sort | uniq \
            > normalized_direct_allowlist.txt

          echo "Normalizing merged DIRECT list (all_direct_rules.tmp)..."
          cat all_direct_rules.tmp | normalize_rules > normalized_direct_list.txt || true

          echo "Filtering DIRECT list against allowlist..."
          grep -F -v -x -f normalized_direct_allowlist.txt normalized_direct_list.txt > filtered_direct_list.txt || true
          echo "DIRECT allowlist filtering complete."

      - name: 11. Format DIRECT List
        run: |
          echo "Sorting and deduplicating filtered DIRECT list..."
          cat filtered_direct_list.txt | sort | uniq > final_direct_domains.txt || true
          echo "Reformatting for DIRECT YAML payload..."
          echo "#########################################" > final_direct.yaml
          echo "# 作者: ningcol" >> final_direct.yaml
          echo "# 项目地址: https://github.com/ningcol/clash-rules" >> final_direct.yaml
          echo "# 更新时间: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> final_direct.yaml
          echo "# 说明: 本文件为自动生成的 Clash DIRECT 规则，仅包含域名。" >> final_direct.yaml
          echo "#########################################" >> final_direct.yaml
          echo "payload:" >> final_direct.yaml
          sed "s/^\(.*\)$/  - '\1'/" final_direct_domains.txt >> final_direct.yaml
          echo "DIRECT build complete. Final file is final_direct.yaml"

      # =======================================================
      #  处理 MICROSOFT 规则
      # =======================================================

      - name: 12. Build MICROSOFT List
        run: |
          echo "Starting MICROSOFT rule download and merge process..."
          touch all_microsoft_rules.tmp
          while IFS= read -r url || [[ -n "$url" ]]; do
            if [[ "$url" == \#* ]] || [[ -z "$url" ]]; then continue; fi
            echo "  [MICROSOFT] Processing URL: $url"
            curl -s -L -o rule_content.tmp "$url"
            if [ ! -s rule_content.tmp ]; then
              echo "  -> WARNING: Failed to download or file is empty."
              continue
            fi
            if cat rule_content.tmp | yq e '.payload[]' - >> all_microsoft_rules.tmp 2>/dev/null; then
              echo "  -> Parsed as YAML (raw merge)"
            else
              cat rule_content.tmp >> all_microsoft_rules.tmp
              echo "  -> Parsed as TXT (raw merge)"
            fi
          done < microsoft/microsoft_sources.list
          rm -f rule_content.tmp
          cat microsoft/microsoft.txt >> all_microsoft_rules.tmp
          echo "MICROSOFT list merge complete."

      - name: 13. Filter MICROSOFT List
        run: |
          normalize_rules() {
            sed "s/'//g" \
            | sed -E 's/^\s*#.*//' \
            | sed -E '/^\s*$/d' \
            | sed -E 's/^(DOMAIN|DOMAIN-SUFFIX|IP-CIDR|IP-CIDR6),([^,]+).*/\2/' \
            | grep -v 'payload:' | grep -v '/' | grep -v ':' | grep -v '@' \
            | tr '[:upper:]' '[:lower:]'
          }

          echo "Normalizing MICROSOFT allowlist (microsoft/exclude.txt)..."
          cat microsoft/exclude.txt \
            | sed "s/'//g" \
            | sed -E 's/^\s*#.*//' \
            | sed -E '/^\s*$/d' \
            | tr '[:upper:]' '[:lower:]' \
            | sort | uniq \
            > normalized_microsoft_allowlist.txt

          echo "Normalizing merged MICROSOFT list (all_microsoft_rules.tmp)..."
          cat all_microsoft_rules.tmp | normalize_rules > normalized_microsoft_list.txt || true

          echo "Filtering MICROSOFT list against allowlist..."
          grep -F -v -x -f normalized_microsoft_allowlist.txt normalized_microsoft_list.txt > filtered_microsoft_list.txt || true
          echo "MICROSOFT allowlist filtering complete."

      - name: 14. Format MICROSOFT List
        run: |
          echo "Sorting and deduplicating filtered MICROSOFT list..."
          cat filtered_microsoft_list.txt | sort | uniq > final_microsoft_domains.txt || true
          echo "Reformatting for MICROSOFT YAML payload..."
          echo "#########################################" > final_microsoft.yaml
          echo "# 作者: ningcol" >> final_microsoft.yaml
          echo "# 项目地址: https://github.com/ningcol/clash-rules" >> final_microsoft.yaml
          echo "# 更新时间: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> final_microsoft.yaml
          echo "# 说明: 本文件为自动生成的 Clash MICROSOFT 规则，仅包含域名。" >> final_microsoft.yaml
          echo "#########################################" >> final_microsoft.yaml
          echo "payload:" >> final_microsoft.yaml
          sed "s/^\(.*\)$/  - '\1'/" final_microsoft_domains.txt >> final_microsoft.yaml
          echo "MICROSOFT build complete. Final file is final_microsoft.yaml"

      # =======================================================
      #  提交所有更改
      # =======================================================
      
      - name: 15. Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Auto-update REJECT, PROXY, DIRECT, and MICROSOFT rules"
          file_pattern: final_reject.yaml final_proxy.yaml final_direct.yaml final_microsoft.yaml
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "github-actions-bot@users.noreply.github.com"
          commit_author: "GitHub Actions Bot <github-actions-bot@users.noreply.github.com>"
